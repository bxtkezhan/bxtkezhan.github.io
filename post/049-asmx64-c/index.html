<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="description" content="在有操作系統的情況下使用純彙編開發程序的情況非常少，即便是不得不用彙編的場景也常常是使用彙編結合高級編程語言的方式進行開發。下面我們來了解一下如何在彙編之中調用C程序以及在C程序中調用彙編。">
<meta name="keywords" content="汇编,编译,连接,编程,asm,nasm,linux">
<meta name="author" content="bxtkezhan@kk">
<meta name="generator" content="Hugo 0.68.3" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="bxtkezhan@kk">
<title>汇编语言「Linux/x86-64」・調用C程序 - bxtkezhan@kk</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7VMHQ286BK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-7VMHQ286BK');
</script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script>MathJax = {tex: {inlineMath: [['$', '$']]}, svg: {fontCache: 'global'}};</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
<script src="/js/player.js"></script>
</head>
<body>

<header>
  <div class="container clearfix">
    <a class="path" href="http://bxtkezhan.xyz/">[bxtkezhan@kk]</a>
    <span class="caret"># _</span>
    <div class="right">
      
      
        <a class="path" style="color: var(--base0e)"href="/widle/">widle</a>
      
    </div>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2021-10-17">October 17, 2021</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="/categories/%E7%BC%96%E8%AF%91">编译</a>

    </span>


  </div>
  <h1 class="headline" itemprop="headline">汇编语言「Linux/x86-64」・調用C程序</h1>
  <section class="body" itemprop="articleBody">
    <p>在有操作系統的情況下使用純彙編開發程序的情況非常少，即便是不得不用彙編的場景也常常是使用彙編結合高級編程語言的方式進行開發。下面我們來了解一下如何在彙編之中調用C程序以及在C程序中調用彙編。</p>
<h3 id="在彙編中調用c">在彙編中調用C</h3>
<p>我們藉助gcc也可以替代ld完成連接。除此之外，我們還可以在彙編代碼中調用C標準函數:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#75715e">; filename: callc.asm</span>

<span style="color:#66d9ef">global</span> main
<span style="color:#66d9ef">extern</span> puts

<span style="color:#66d9ef">section</span> .text

main:
    <span style="color:#a6e22e">mov</span> rdi, message
    <span style="color:#a6e22e">call</span> puts
    <span style="color:#a6e22e">ret</span>

message:
    <span style="color:#66d9ef">db</span> <span style="color:#e6db74">&#34;Hello, World&#34;</span>, <span style="color:#ae81ff">0</span>
</code></pre></div><p>這是由之前的示例代碼修改而成的調用C標準函數<code>puts</code>打印輸出的代碼，它的編譯連接方法如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nasm -felf64 callc.asm <span style="color:#75715e"># 首先生成目標文件</span>
gcc -no-pie callc.o <span style="color:#75715e"># 對目標文件進行連接操作</span>
</code></pre></div><p>當我們在64位的Linux操作系統下編寫這類調用C標準庫的彙編程序時應該注意到一些函數調用的規範。關於詳細的信息可以從<a href="https://en.wikipedia.org/wiki/X86_calling_conventions#x86-64_Calling_Conventions">維基百科</a>中獲得。這裏主要列出最重要的幾點:</p>
<ul>
<li>传递参数时，按照从左到右的顺序，将尽可能多的参数依次保存在寄存器中。存放位置的寄存器顺序是确定的：
<ul>
<li>对于整数和指针，rdi，rsi，rdx，rcx，r8，r9。</li>
<li>对于浮点数（float和double类型），xmm0，xmm1，xmm2，xmm3，xmm4，xmm5，xmm6，xmm7。</li>
</ul>
</li>
<li>剩下的参数将按照从右到左的顺序压入栈中，并在调用之后由调用函数推出栈。</li>
<li>等所有的参数传入后，会生成调用指令。所以当被调用函数得到控制权后，返回地址会被保存在[rsp]中，第一个局部变量会被保存在[rsp+8]中，以此类推。</li>
<li>栈指针rsp在调用前必须进行16字节对齐处理。当然，调用的过程中只会把一个8bytes的返回地址推入栈中，所以当函数得到控制权时，rsp并没有对齐。你需要向栈中压入数据或者从rsp减去8来使之对齐。</li>
<li>被调用函数需要保存如下的寄存器：rbp，rbx，r12，r13，r14，r15。其他的寄存器可以自由使用。</li>
<li>被调用函数也需要保存XMCSR的控制位和x87指令集的控制字，但是x87指令在64位系统上十分少见所以你不必担心这点。</li>
<li>整数返回值存放在rax或者rdx:rax中，浮点数返回值存放在xmm0或者xmm1:xmm0中。</li>
</ul>
<p>下列代碼是上述規範的示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#66d9ef">global</span> main
<span style="color:#66d9ef">extern</span> printf

<span style="color:#66d9ef">section</span> .text

main:
    <span style="color:#a6e22e">push</span> rax        <span style="color:#75715e">; 壓入rax的值到棧</span>
    <span style="color:#a6e22e">mov</span> rdi, format <span style="color:#75715e">; 從左到右第一個參數 format</span>
    <span style="color:#a6e22e">mov</span> rsi, <span style="color:#ae81ff">10</span>     <span style="color:#75715e">; 從左到右第二個參數 數字10</span>
    <span style="color:#a6e22e">mov</span> rdx, <span style="color:#ae81ff">20</span>     <span style="color:#75715e">; 從左到右第三個參數 數字20</span>
    <span style="color:#a6e22e">mov</span> rcx, rsi
    <span style="color:#a6e22e">add</span> rcx, rdx    <span style="color:#75715e">; 從左到右第四個參數 10 + 20</span>
    <span style="color:#75715e">; 我們壓入了一個rax加上返回地址就對齊了16bytes</span>
    <span style="color:#a6e22e">call</span> printf
    <span style="color:#a6e22e">pop</span> rax         <span style="color:#75715e">; 從棧中彈出原本rax的值到rax</span>
    <span style="color:#a6e22e">ret</span>

format:
    <span style="color:#66d9ef">db</span> <span style="color:#e6db74">&#34;%ld + %ld = %ld&#34;</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>
</code></pre></div><h3 id="在c語言中調用彙編程序">在C語言中調用彙編程序</h3>
<p>我們先來用彙編寫一個int64類型max函數，用於返回兩個int64類型的參數中最大的數值:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#66d9ef">global</span> maxi64

<span style="color:#66d9ef">section</span> .text

maxi64:
    <span style="color:#75715e">; 根據規則，rax存儲返回值，先將第一個參數rdi的值給到它</span>
    <span style="color:#a6e22e">mov</span> rax, rdi
    <span style="color:#75715e">; 對比第一個參數和第二個參數大小</span>
    <span style="color:#a6e22e">cmp</span> rax, rsi
    <span style="color:#75715e">; cmovl表示根據上一個cmp的比較結果來決定是否進行mov操作</span>
    <span style="color:#75715e">; 如果是rax &lt; rsi則mov rax, rsi</span>
    <span style="color:#a6e22e">cmovl</span> rax, rsi
    <span style="color:#a6e22e">ret</span>
</code></pre></div><p>接下來我們編寫C語言程序調用它:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;inttypes.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
int64_t <span style="color:#a6e22e">maxi64</span>(int64_t, int64_t);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    printf(<span style="color:#e6db74">&#34;%ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, maxi64(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span>));
    printf(<span style="color:#e6db74">&#34;%ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, maxi64(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>));
    printf(<span style="color:#e6db74">&#34;%ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, maxi64(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">3</span>));
    printf(<span style="color:#e6db74">&#34;%ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, maxi64(<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">1</span>));
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>假定彙編文件名爲<code>maxi64.asm</code>；C程序文件名爲<code>test_maxi64.c</code>。我們使用如下命令進行編譯與運行:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nasm -felf64 maxi64.asm
gcc test_maxi64.c maxi64.o
./a.out
</code></pre></div>
  </section>
</article>

</main>

</div>

<footer>
  <div class="container">
    友情分享:
    
    <span><a href="https://wd.bible/">微读圣经</a></span>
    
    <span><a href="https://cnbible.com/">网上圣经</a></span>
    
  </div>
  <div class="container">
    <span class="copyright">&copy; 2021 bxtkezhan@kk - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>

